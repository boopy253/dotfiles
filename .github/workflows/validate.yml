name: Validate Dotfiles

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint shell scripts
        run: |
          brew install shellcheck
          shellcheck install.sh uninstall.sh wrap.sh

      - name: Validate JSON files
        run: |
          for file in $(find .config -name "*.json" 2>/dev/null); do
            echo "Checking: $file"
            jq . "$file" > /dev/null || exit 1
          done

      - name: Verify symlink targets exist
        run: |
          echo "Checking if all referenced files exist..."
          expected_files=(
            ".editorconfig"
            ".fzf.zsh"
            ".gitconfig"
            ".gitignore_global"
            ".gitmessage"
            ".p10k.zsh"
            ".vimrc"
            ".zprofile"
            ".zshenv"
            ".zshrc"
          )
          
          for file in "${expected_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "❌ Missing file: $file"
              exit 1
            fi
            echo "✓ $file"
          done

      - name: Check for EditorConfig issues
        run: |
          if command -v editorconfig-checker &> /dev/null; then
            editorconfig-checker .
          else
            echo "editorconfig-checker not installed, skipping"
          fi

      - name: Validate git config syntax
        run: |
          git config -f .gitconfig --list > /dev/null && echo "✓ .gitconfig valid"

      - name: Check for trailing whitespace
        run: |
          if git grep -n '[[:space:]]$' -- '*.sh' '*.zsh' '*.lua' '*.md'; then
            echo "❌ Found trailing whitespace"
            exit 1
          else
            echo "✓ No trailing whitespace found"
          fi

  security:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          if grep -r "BEGIN RSA PRIVATE KEY" . 2>/dev/null || \
             grep -r "BEGIN OPENSSH PRIVATE KEY" . 2>/dev/null; then
            echo "❌ Found private keys in repository!"
            exit 1
          else
            echo "✓ No private keys detected"
          fi

      - name: Check for hardcoded credentials
        run: |
          if grep -rE '(password|secret|token|api_key|AWS_SECRET)' . \
               --include="*.sh" --include="*.zsh" --include="*.lua" 2>/dev/null | \
             grep -v '# ' | grep -v '.gitmessage'; then
            echo "⚠️  Potential hardcoded credentials detected (check if intentional)"
          else
            echo "✓ No obvious hardcoded credentials"
          fi
