name: Validate Dotfiles

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint shell scripts
        run: |
          brew install shellcheck
          shellcheck install.sh uninstall.sh

      - name: Validate JSON files
        run: |
          for file in $(find .config -name "*.json" 2>/dev/null); do
            echo "Checking: $file"
            jq . "$file" > /dev/null || exit 1
          done

      - name: Verify symlink targets exist
        run: |
          echo "Checking if all referenced files exist..."
          expected_files=(
            ".editorconfig"
            ".fzf.zsh"
            ".gitconfig"
            ".gitignore_global"
            ".gitmessage"
            ".p10k.zsh"
            ".vimrc"
            ".zprofile"
            ".zshenv"
            ".zshrc"
          )
          
          for file in "${expected_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "❌ Missing file: $file"
              exit 1
            fi
            echo "✓ $file"
          done

      - name: Validate git config syntax
        run: |
          git config -f .gitconfig --list > /dev/null && echo "✓ .gitconfig valid"

      - name: Check for trailing whitespace
        run: |
          if git grep -n '[[:space:]]$' -- '*.sh' '*.zsh' '*.lua' '*.md'; then
            echo "❌ Found trailing whitespace"
            exit 1
          else
            echo "✓ No trailing whitespace found"
          fi
